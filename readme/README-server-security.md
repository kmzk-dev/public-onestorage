## ONESTORAGE - SERVER SECURITY

このドキュメントは、ONESTORAGEのセキュリティ設計における**考え方**とデータ保護に関する**意図的なトレードオフ**について説明するものです。  
ご利用前に、本システムの根本的な設計原則を十分にご理解ください。

---

## サーバーセキュリティの考え方：
ONESTORAGEは、サーバーへの侵入（クラック）が発生した場合のファイル暗号化を**提供しません**。  
また今後も提供するつもりはありません。  
これは事前にユーザーに対して、保存しないデータを明らかにしていることが理由の一つです。
そして、コストや機能性のトレードオフと、サーバーセキュリティに対する根本的な思想に基づくものです。

### データの侵害は「侵入時」に成立する
もし、あなたの家が泥棒に入られた形跡があったのに何も盗まれたてなかったらどうしますか?
「盗まれた」「被害があった」という結果をもって侵害が成立するというわけではありません。 
もしかするとあなたの家に巧みに監視カメラが仕掛けられているかもしれませんし、気づかないところで侵害がされているかもしれません。

- **侵害の定義**: サーバークラック（脅威アクターによる侵入）が発生した時点で、データの機密性および完全性の侵害は成立します。サーバーという倉庫に泥棒が入った時点で、侵入という事実自体が侵害だからです。
- **証明不能性**: 侵入者が何も盗まなかったとしても、第三者からは「盗まれたか否か」を確実に証明する手段がありません。これはまさにシュレディンガーの猫です。この不確実性が生じた時点で、データの機密性は破綻していると判断します。

**サーバークラックされた段階で、データは保護や状態の有無にかかわらず侵害されたとみなすのが合理的でなのです。**

### ファイル暗号化への批判的視点と保証されない安全性
多くのファイルストレージサービスでファイルそのものに暗号化が施されていますが、それは**安全性が保証されたものではない**と考えています。

- **暗号化の実態**: 多くのサービスでファイル暗号化が実装されています。これは間違ったアプローチではありませんし、本来あるべきスタイルです。しかし、「暗号化されているから安全」というロジックは、脅威アクター（攻撃者）の思考をトレースするとありえません。実際にはユーザーに**安心感**を与えるに留まり、確実な安心ではないことを知るべきです。
- **脅威アクターの思考**: 脅威アクターは、暗号化された大量のファイルを復号化するよりも、サーバー上に存在する**暗号化キー、環境設定、または秘密鍵**といった**「秘密の宝箱」**を窃取することを優先します。
- **保証の欠如**: サーバーに侵入を許した段階で、他のシステムや暗号化キーなどが奪われていないという保証は誰にもできず、これらが奪われている場合、ファイル暗号化は全く意味をなしません。

###　暗号化はシステムの軽量性を損なう
現在のシステム構成でもファイルそのものを暗号化することは可能であり、技術的に困難ではありません。
あなたがソースを改変しファイル暗号化も組み込みたい場合のために、技術的に必要なプロセスを明らかにしておきます。

1. 初期設定時点で環境変数に暗号キーを自動生成します。
1. ローカル復元用に、自動生成された暗号キーをユーザーに一度だけ表示し、保存してもらいます。
1. チャンク処理する際、ファイルストリーム内でバイナリデータに対し暗号キーを適用し、ファイル暗号化します。
1. 表示のためにシステムベースのダウンロード/ビューアーに切り替え、サーバー上の秘匿キーでファイルを復号しながらストリームします。
1. システムが機能停止した場合に備え、ユーザーに一度表示した暗号キーでローカルにて復元できる専用のシステム（バックアップ機構）を提供します。

ONESTORAGEは、低スペックなレンタルサーバー（場合によってはVPS）環境での**軽量動作**を最優先しています。　　
それにサーバーそのものに不正アクセスされた場合、環境変数は用意に奪われるでしょう。
本質的に意味をなさない可能性が高い暗号化と復号化の処理は、システムに**無駄な性能負荷（オーバーヘッド）**をかけるだけであると判断し、今後も不採用としています。

---

### ONESTORAGEの防御機構：入口対策と秘密の隔離
ONESTORAGEは、「サーバー侵入後の防御」を諦める代わりに、「サーバー侵入前の入口対策」と「秘密情報の隔離・隠蔽」を徹底し、システムに堅牢性をもたせています。

| 防御の種類 | 対策の目的 | 具体的実装 | 参照 |
| :--- | :--- | :--- | :--- |
| **厳格な認証** | アカウントの不正利用による侵入を阻止 | TOTP方式による**MFAの強制**とパスワードの厳格な検証 | `setting.php`, `login.php`, `mfa_login.php` |
| **実行コンテクスト制御** | アプリケーションコアロジックへの直接アクセス防御 | エントリポイント外からのPHPファイル実行時に即座に拒否 (`define('ONESTORAGE_RUNNING', true)`) | `handler_post_method.php`など |
| **秘密情報の秘匿** | 設定ファイルやデータフォルダの特定を困難に | ランダムな15文字のデータフォルダ名自動生成、`.htaccess`による設定ファイル群（`/config`、データフォルダ）の外部アクセス遮断 | `setting.php`, `.gitignore` |

---

##　根本的な脆弱性とユーザーの責任（重要事項）
ONESTORAGEは、DBレスで超軽量なファイルストレージである代わりに、そのファイル保存に**根本的な脆弱性**をもっています。
この脆弱性を容認する理由はこれまでに述べたとおりです。

###　生データ保存のリスクとメリット

| 特徴 | 説明 |
| :--- | :--- |
| **リスク（脆弱性）** | サーバーに**生のデータ**を直接保存するため、サーバーがクラックされた場合、データは暗号化されずに直接的に奪われるリスクがあります。 |
| **メリット（トレードオフ）** | システムがクラッシュしたとき、ユーザーはFTP等でサーバーに保存されているデータを**高確率で取り戻すことができる**という、高いデータ復元性を持ちます。 |

###　ユーザーに要請する責任
実際のところシステム側でサーバーのセキュリティを担保する方法はありません。
サーバーセキュリティの対策をできるのはサーバー提供事業者とその契約者のみです。
本システムの利用は個人の責任で行ってください。
サーバークラックの脅威を最小化するためには、ユーザー自身の運用管理が不可欠です。

* **保存を非推奨とするデータ**: サーバークラック時に損害を被るデータは、より厳格なセキュリティで管理されるサービスを利用してください。
    * 例: ID/パスワード、金融資産データ、重要契約書
* **推奨される保存データ**: 大手クラウドサービスの**AI監査や外部の検閲**から切り離したい、機密性の高いプライベートデータ（個人的な写真、私的な創作物など）の保管に適しています。

### ユーザーがサーバーを守るためにとるべき行動
サーバーセキュリティは、最終的にユーザー自身の運用管理に依存します。
サーバークラックの脅威を最小化し、システムを安全に利用するために、以下の行動を厳守してください。
- 認証情報の厳格化: サーバーにアクセスするためのログインパスワード、およびIDを極力厳格に管理してください。特にパスワードは15桁以上・大小英字、数字できれば特殊文字を含むを構成をとってください。
- 二段階認証の利用: サーバーアクセスに対して、なんらかの二段階認証が設定できる場合は、必ず実施してください。

## VPSを推奨しない理由
ONESTORAGEは制約・リソース制限の多いレンタルサーバー環境で動作するよう設計されています。
そのため、ユーザーがより多くの権限をもつVPS環境でも動作しますが、VPS環境を主な推奨対象とはしていません。

- **責任範囲の拡大:** VPSでは、サーバーの稼働、運用管理、セキュリティ等、より多くの責任をユーザー自身が負うことになります。
- **ツールの目的との齟齬:** 多くのユーザーがこれらの高度な対策を完璧に行えるとは考えていません。これは開発者自身がこれを完璧にできる気がしないからというのもあります。また、そうした対策に自信があるユーザーであれば、ONESTORAGEのような軽量ツールではなく、より複雑なフル機能のファイルサービスをVPS環境に構築するはずです。

もちろん、ONESTORAGEが推奨する「漏洩しても実害がなく、プライバシー保護が目的のデータ」を保管する場合であれば、VPS環境での運用も可能です。