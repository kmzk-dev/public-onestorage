## ONESTORAGE - DEVELOPMENT
このドキュメントは、開発者向け情報を掲載しています。

### 設計思想と意図的な簡素化の理由
サーバー知識がなくても利用できることを重視しています。
そのため、本来推奨される構造化されたディレクトリ構成でなく、`/functions` と `/static`という最小限の構造を採用しています。

- **ディレクトリ構成:** 非エンジニアのデプロイ担当者にとってのミスや挫折を避けるため、ファイル配置を極限までシンプルにしました。
- **セキュリティの担保:** サーバー固有の設定（例：.htaccess）に依存せず、コードロジックによる移植性の高い防御を主軸とすることで、この構造の安全性を確立しています。

このシンプルな構成は、**「デプロイの容易性」と「厳格なセキュリティ」**という二律背反する目標を両立させるために選択された、合理的なアプローチであることをご理解ください。

### ディレクトリ構成
万人の利用を想定してデプロイを簡略化するため、意図的に簡素なディレクトリ構成を行っております。
これによりユーザーがFTPやSSHなどによるデプロイができない場合でも、インストールを簡易にします。

```TEXT
.
├──functions
│   └── 機能群
├──static
│   └── 公開アセット群
└──index.php ...ETC

```
### 命名規則
#### /functions
ファイル名はその内容を簡潔に表すものとします。
function等のプレフィックスは不要とします。
```TEXT
EXAMPLE: auth.php、helpers.php
```

#### /static
このディレクトリ内のファイルには、ファイル名に詳細な役割を示す情報を含める規則を適用しています。

``` TEXT
ファイル名の構造: [役割カテゴリ]-[ファイルの用途].[拡張子]
```
役割カテゴリがPREFIXですが、これは本来のディレクトリの役割を果たします。

|役割カテゴリ|説明|ファイル例|
|-|-|-|
|templates|ページ全体の枠組みとなるView|template-head.php|
|component|再利用可能なUI部品|component-uploadmodal.php|
|img|画像ファイル||
|asset|JS, CSSなどの静的リソース||

### セキュリティ
DBを持たないため監査ログなどの実装は行いません。

#### 設定情報の自動生成と秘匿化
重要な設定情報を格納するディレクトリ・ファイルは自動生成することでインストールするユーザーのミスによる漏洩を防止します。
また、以下の方法により外部からの特定・攻撃を困難にします。

- **データフォルダ:** 解析困難なデータフォルダ名: ユーザーファイルや機密設定を格納するルートフォルダは、ランダムな15文字で自動生成され、場所の推測・特定を困難にします。
- **隠しファイルによる秘匿:** システムが利用するキャッシュや一時ファイル格納領域は、.（ドット）で始まる隠しファイルとして処理します。
- **htaccess制御:** データフォルダや設定情報はhtaccessにより外部アクセスを遮断しています。
- 
#### 実行コンテクスト制御
/functions内のPHPファイルにある不正操作につながるコアロジックには外部からのACCESSを防御する機構を組み込みます。

- エントリポイント（index.php、login.phpなど）で define('ONESTORAGE_RUNNING', true); を定義します。
- ロジックファイルは、この定数が定義されていない場合、即座に die('Access Denied: Invalid execution context.'); を実行し、不正な直接アクセスを拒否します

|ファイル名|責任|保護|
|-|-|-|
|handler_post_method.php|crud操作|実行コンテキスト制御|
|handler_get_method.php|ファイル表示、ダウンロード|実行コンテキスト制御|
|chunk_upload.php|ファイルアップロード|実行コンテキスト制御|
|init.php|システムコア設定|実行コンテキスト制御|

これにより、CRUD操作・アップロードに関する実行は正規のエントリポイントのみを許可し、外部からの不正操作を防御します。
```text
APIエントリーポイントを利用する場合、実行コンテキストは送信されません。
重要なエントリーポイントについてはセッション情報などを利用したワンタイムトークンなどの利用を検討する必要があります。
```

#### 運用制御
データを安全に管理するためには、認証レベルでアクセス制限を行う必要があります。
ユーザーのセキュリティリテラシーに依存しないため、認証情報をシステム側で強制します。
- パスワードの厳格化: パスワードの組み合わせ基準に規定を設けます。これらのバリデーションチェックはフロントのみで行わず、バックエンド検証が必須です。
  - APIエントリーポイントは`functions/setting.php`です。
- MFAの強制: 認証アプリを利用した二段階認証（MFA）は必須にします。認証方式についてはTOTP方式を採用します。
  - APIエントリーポイントは`functions/mfa.php`です。


